{% extends 'base.html.jinja2' %}

{% block head_content %}
    <meta name="description" content="Page permettant l'affichage des vidéos afin de laisser un commentaire.">
    <title>{% block title %}Espace commentaire des vidéos{% endblock %}</title>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='CSS/subject_forum.css') }}">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
{% endblock %}

    {% block header_content %}
    {% endblock %}

{% block main_content %}
<br>
<div>
    <button class="back"><a href="{{ url_for('frontend.show_videos') }}">Retour aux vidéos</a></button>
</div>
<br>
<section>
    <h1>Vidéo sélectionnée</h1>
    <br>
    <div id="container-vidéo">
        <br>
        <div class="video-item">
            <h3>{{ video.title }}</h3>
            <iframe width="560" height="315" src="https://www.youtube.com/embed/{{ video.video_id }}"
                    frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture"
                    allowfullscreen></iframe>
            <br>
            <div class="informations">
                <p>Date de publication : {{ video.published_at }}</p>
                <p>Vues : {{ video.view_count }}</p>
                <p>Likes : {{ video.like_count }}</p>
            </div>
        </div>
    </div>
    <div id="container-comment">
        {% for comment in comment_video %}
        <div id="comment">
            <div class="comment-header">
                <img src="{{ url_for('user.profil_photo', user_id=comment.user_id) }}" alt="Photo de profil" class="profile-picture">
            </div>
            <div class="comment">
                <strong>{{ comment.user.pseudo }}</strong> a commenté :
            </div>
            <div class="comment">
                <i>{{ comment.user.role }}</i>
            </div>
            <div class="date-comment">
                <small>Le {{ moment(comment.comment_date).format('DD-MM-YYYY à HH:MM') }}</small>
            </div>
            <div class="content-comment">
                {{ comment.comment_content | replace('\n', '<br>') | safe }}
            </div>
            <div class="change-comment">
                {% if comment.user_id == current_user.id %}
                <a href="{{ url_for('user.change_comment_video', id=comment.id) }}">Modifier le commentaire</a>
                <form action="{{ url_for('user.delete_comment_video', id=comment.id) }}" method="POST" style="display:inline;">
                    {{ formsuppress.csrf_token }}
                    <input class="suppress-button" type="submit" value="Supprimer le commentaire" onclick="return confirm('Êtes vous certain de vouloir supprimer votre commentaire ?');">
                </form>
                {% endif %}
            </div>
        </div>
        <div class="reply-button-container">
            <a href="{{ url_for('user.reply_form_video', comment_id=comment.id, user_pseudo=current_user.pseudo) }}" class="reply-button">Répondre</a>
            <div class="like-section" data-user-id="{{ current_user.pseudo }}">
                <form id="formlikecomment" method="POST" action="{{ url_for('user.likes_comment_video') }}" style="display: none;">
                    {{ formlikecomment.csrf_token }}
                    <input type="hidden" name="comment_id" value="{{ comment.id }}">
                    <input type="hidden" name="user_pseudo" value="{{ current_user.pseudo }}">
                    <button type="submit" class="like-submit"></button>
                </form>
                <div class="like-icon" data-comment-id="{{ comment.id }}" onclick="toggleLike(this, '{{ comment.id }}', '{{ current_user.pseudo }}')" style="cursor: pointer;">
                    {% if comment_likes_data[comment.id].liked_by_current_user %}
                    &#9829; <!-- Icône pour un cœur plein -->
                    {% else %}
                    &#9825; <!-- Icône pour un cœur vide -->
                    {% endif %}
                </div>
                <div class="liked-users">
                    <p id="like-message-{{ comment.id }}">
                        {% set like_data = comment_likes_data[comment.id] %}
                        {% if like_data.like_count > 0 %}
                            {{ current_user.pseudo if current_user.id in like_data.liked_user_ids else '1 utilisateur a aimé le commentaire.'}}
                            {% if like_data.like_count > 1 %}
                                et {{ like_data.like_count - 1 }} autre(s) utilisateur(s) ont aimé le commentaire.
                            {% endif %}
                        {% else %}
                            Personne n'a aimé le commentaire pour le moment.
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>
        <div class="replies">
            {% for reply in comment.replies %}
            <div class="comment-reply">
                <div class="reply-header">
                    <img src="{{ url_for('user.profil_photo', user_id=reply.user_id) }}" alt="Photo de profil" class="profile-picture">
                    <div class="reply-details">
                        <strong><i>{{ reply.user.pseudo }}</i></strong> a répondu :
                    </div>
                    <div class="reply-details">
                        <i>{{ reply.user.role }}</i>
                    </div>
                    <div class="reply-date">
                         <small>Le {{ moment(reply.reply_date).format('DD-MM-YYYY à HH:mm') }}</small>
                    </div>
                </div>
                <div class="content-reply">
                    {{ reply.reply_content | replace('\n', '<br>') | safe }}
                </div>
                <div class="change-reply">
                {% if reply.user_id == current_user.id %}
                    <a href="{{ url_for('user.change_reply_video', id=reply.id) }}">Modifier la réponse</a>
                    <form action="{{ url_for('user.delete_reply_video', id=reply.id) }}" method="POST" style="display:inline;">
                    {{ formsuppressreply.csrf_token }}
                        <input class="suppress-button" type="submit" value="Supprimer la réponse" onclick="return confirm('Êtes vous certain de vouloir supprimer votre réponse ?');">
                    </form>
                {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% endfor %}
    </div>
    <br>
    <div id="comment-avis">
        <h2>Vous pouvez laisser un commentaire :</h2>
        <br>
        <div class="form-comment">
            <form method="POST" action="{{ url_for('user.comment_video', user_pseudo=current_user.pseudo, video_id=video.id) }}">
                {{ formcomment.csrf_token }}
                <input type="hidden" name="video_id" value="{{ video.id }}">
                <input type="hidden" name="user_pseudo" value="{{ current_user.pseudo }}">
                <textarea name="comment_content" placeholder="Votre commentaire" required></textarea>
                <button type="submit">Poster le commentaire</button>
            </form>
        </div>
    </div>
</section>
<br>

{% endblock %}
{% block footer_content %}
<script src="{{ url_for('static', filename='CSS/javascript/like_comment_video.js') }}"></script>
{% endblock %}